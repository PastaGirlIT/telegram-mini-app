<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Team App</title>
  <script src="https://telegram.org/js/telegram-web-app.js?v=777"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Arial;background:#f5f5f5;margin:0;padding:16px}
    .card{background:#fff;border-radius:12px;padding:12px;margin:12px 0}
    h2,h3{margin:8px 0;text-align:center}
    .btn{width:100%;padding:12px;margin:8px 0;border:0;border-radius:10px;font-size:16px}
    .primary{background:#2AABEE;color:#fff}
    .secondary{background:#e6e6e6}
    .warn{background:#fb8500;color:#fff}
    .hidden{display:none}
    input,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
    .miniBtn{display:inline-block;width:auto;margin:6px 6px 0 0;padding:8px 10px}
    .status{white-space:pre-wrap;font-size:13px;opacity:.9}
    .row{display:flex;gap:8px}
    .row input{flex:1}
  </style>
</head>
<body>

<h2>–û—Ç—á—ë—Ç—ã</h2>

<div id="status" class="card status">–°—Ç–∞—Ç—É—Å: –≥–æ—Ç–æ–≤–æ</div>

<div id="roleScreen" class="card">
  <h3>–ö—Ç–æ —Ç—ã —Å–µ–≥–æ–¥–Ω—è?</h3>
  <button class="btn primary" onclick="setRole('–ø–æ–≤–∞—Ä')">üë®‚Äçüç≥ –ü–æ–≤–∞—Ä</button>
  <button class="btn primary" onclick="setRole('–∫–∞—Å—Å–∏—Ä')">üí≥ –ö–∞—Å—Å–∏—Ä</button>
</div>

<div id="cookMenu" class="card hidden">
  <h3>–ú–µ–Ω—é –ø–æ–≤–∞—Ä–∞</h3>
  <button class="btn secondary" onclick="openCookPrep()">üçù –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</button>
  <button class="btn secondary" onclick="openCookWriteoff()">üóë –°–ø–∏—Å–∞–Ω–∏–µ</button>
  <button class="btn secondary" onclick="openCookBreakdown()">üì¶ –†–∞–∑–±–æ—Ä</button>
  <button class="btn warn" onclick="resetRole()">üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
</div>

<div id="cashierMenu" class="card hidden">
  <h3>–ú–µ–Ω—é –∫–∞—Å—Å–∏—Ä–∞</h3>
  <button class="btn secondary" onclick="openCash('–≤–Ω–µ—Å–µ–Ω–∏–µ')">‚ûï –í–Ω–µ—Å–µ–Ω–∏–µ</button>
  <button class="btn secondary" onclick="openCash('–∏–∑—ä—è—Ç–∏–µ')">‚ûñ –ò–∑—ä—è—Ç–∏–µ</button>
  <button class="btn secondary" onclick="openCashWriteoff()">üóë –°–ø–∏—Å–∞–Ω–∏–µ</button>
  <button class="btn warn" onclick="resetRole()">üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
</div>

<div id="workScreen" class="card hidden">
  <h3 id="workTitle">...</h3>

  <div id="dynamic"></div>

  <div id="qtyBlock" class="hidden">
    <input id="qty" type="number" inputmode="decimal" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <div id="unitBar" class="status"></div>
    <textarea id="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>

    <button class="btn primary" onclick="sendCook()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button class="btn secondary" onclick="backToMenu()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="cashBlock" class="hidden">
    <div class="row">
      <input id="rub" type="number" inputmode="numeric" placeholder="–†—É–±–ª–∏">
      <input id="kop" type="number" inputmode="numeric" placeholder="–ö–æ–ø–µ–π–∫–∏">
    </div>
    <textarea id="cashReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞"></textarea>

    <button class="btn primary" onclick="sendCash()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button class="btn secondary" onclick="backToMenu()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<script>
Telegram.WebApp.ready();

/https://script.google.com/macros/s/AKfycbzJg3OfKzXXojWydq3d6_mTAn5r6_pv-R_U2_peOwme_wVUc7ZX5hqUKvpH4FhgJQTj/exec/
const API_BASE = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_T–í–û–ô_googleusercontent_echo_URL";

const S = (t)=>document.getElementById(t);
const log = (m)=>S("status").textContent = "–°—Ç–∞—Ç—É—Å: " + m;

let role = localStorage.getItem("role") || "";
let operation = "";
let selectedName = "";
let selectedUnit = "";
let breakdownFrom = "";

boot();

function boot(){
  if(role==="–ø–æ–≤–∞—Ä"){ S("roleScreen").classList.add("hidden"); S("cookMenu").classList.remove("hidden"); log("—Ä–æ–ª—å: –ø–æ–≤–∞—Ä"); }
  else if(role==="–∫–∞—Å—Å–∏—Ä"){ S("roleScreen").classList.add("hidden"); S("cashierMenu").classList.remove("hidden"); log("—Ä–æ–ª—å: –∫–∞—Å—Å–∏—Ä"); }
  else log("–≤—ã–±–µ—Ä–∏ —Ä–æ–ª—å");
}

function setRole(r){
  role=r;
  localStorage.setItem("role", r);
  S("roleScreen").classList.add("hidden");
  if(r==="–ø–æ–≤–∞—Ä") S("cookMenu").classList.remove("hidden");
  if(r==="–∫–∞—Å—Å–∏—Ä") S("cashierMenu").classList.remove("hidden");
  log("—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: "+r);
}

function resetRole(){
  localStorage.removeItem("role");
  role="";
  S("cookMenu").classList.add("hidden");
  S("cashierMenu").classList.add("hidden");
  S("workScreen").classList.add("hidden");
  S("roleScreen").classList.remove("hidden");
  log("—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω–∞");
}

function showWork(title){
  S("cookMenu").classList.add("hidden");
  S("cashierMenu").classList.add("hidden");
  S("workScreen").classList.remove("hidden");
  S("workTitle").textContent = title;
  S("dynamic").innerHTML = "";
  S("qtyBlock").classList.add("hidden");
  S("cashBlock").classList.add("hidden");
  selectedName=""; selectedUnit=""; breakdownFrom="";
}

function backToMenu(){
  S("workScreen").classList.add("hidden");
  if(role==="–ø–æ–≤–∞—Ä") S("cookMenu").classList.remove("hidden");
  if(role==="–∫–∞—Å—Å–∏—Ä") S("cashierMenu").classList.remove("hidden");
  log("–≥–æ—Ç–æ–≤–æ");
}

// ---------- API helpers ----------
async function apiGet(type, params={}){
  const url = new URL(API_BASE);
  url.searchParams.set("type", type);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  log("GET " + type + "‚Ä¶");
  const r = await fetch(url.toString(), { method:"GET" });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"Non-JSON", raw:t.slice(0,300) }; }
}

async function apiPost(payload){
  log("POST‚Ä¶");
  const r = await fetch(API_BASE, {
    method:"POST",
    headers:{ "Content-Type":"application/json;charset=utf-8" },
    body: JSON.stringify(payload),
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:true, raw:t }; }
}

// ---------- COOK ----------
async function openCookPrep(){
  operation="–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ";
  showWork("–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: –≤—ã–±–µ—Ä–∏ –ø–æ–∑–∏—Ü–∏—é");
  const data = await apiGet("prep");
  renderPickButtons(data, (item)=>{
    selectedName=item.name;
    selectedUnit=item.unit;
    S("qtyBlock").classList.remove("hidden");
    S("unitBar").textContent = "–ï–¥. –∏–∑–º.: " + selectedUnit;
    S("reason").placeholder = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)";
    log("–≤—ã–±—Ä–∞–Ω–æ: " + selectedName);
  });
}

async function openCookWriteoff(){
  operation="—Å–ø–∏—Å–∞–Ω–∏–µ";
  showWork("–°–ø–∏—Å–∞–Ω–∏–µ: –≤–≤–µ–¥–∏ –ø–æ–∑–∏—Ü–∏—é");
  S("dynamic").innerHTML = `<input id="freeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏">`;
  S("qtyBlock").classList.remove("hidden");
  S("reason").placeholder = "–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è";
  await renderUnitsBar();
  log("—Å–ø–∏—Å–∞–Ω–∏–µ: –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
}

async function openCookBreakdown(){
  operation="—Ä–∞–∑–±–æ—Ä";
  showWork("–†–∞–∑–±–æ—Ä: –≤—ã–±–µ—Ä–∏ —á—Ç–æ —Ä–∞–∑–±–∏—Ä–∞–µ–º");
  const data = await apiGet("breakdown");
  renderPickButtons(data, async (item)=>{
    breakdownFrom = item.name;
    log("—Ä–∞–∑–±–æ—Ä: –≤—ã–±—Ä–∞–Ω–æ —á—Ç–æ —Ä–∞–∑–±–∏—Ä–∞–µ–º: "+breakdownFrom);
    await openBreakdownTo(breakdownFrom);
  });
}

async function openBreakdownTo(fromName){
  S("workTitle").textContent = `–†–∞–∑–±–æ—Ä: ${fromName} ‚Üí –≤—ã–±–µ—Ä–∏ –Ω–∞ —á—Ç–æ`;
  S("dynamic").innerHTML = "";
  S("qtyBlock").classList.add("hidden");
  const data = await apiGet("breakdown_map", { from: fromName });
  renderPickButtons(data, (item)=>{
    selectedName = `${fromName} ‚Üí ${item.name}`;
    selectedUnit = item.unit;
    S("qtyBlock").classList.remove("hidden");
    S("unitBar").textContent = "–ï–¥. –∏–∑–º.: " + selectedUnit;
    S("reason").placeholder = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)";
    log("–≤—ã–±—Ä–∞–Ω–æ: " + selectedName);
  });
}

function renderPickButtons(data, onPick){
  if(!Array.isArray(data)){
    log("–æ—à–∏–±–∫–∞ API: "+JSON.stringify(data));
    S("dynamic").innerHTML = `<div class="status">–û—à–∏–±–∫–∞ API: ${JSON.stringify(data)}</div>`;
    return;
  }
  if(data.length===0){
    log("—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç");
    S("dynamic").innerHTML = `<div class="status">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—É –∏ active=1.</div>`;
    return;
  }
  data.forEach(item=>{
    const b=document.createElement("button");
    b.className="btn secondary";
    b.textContent = `${item.name} (${item.unit})`;
    b.onclick=()=>onPick(item);
    S("dynamic").appendChild(b);
  });
}

async function renderUnitsBar(){
  const units = await apiGet("units");
  if(!Array.isArray(units)){
    S("unitBar").textContent = "–û—à–∏–±–∫–∞ units: " + JSON.stringify(units);
    return;
  }
  const bar = document.createElement("div");
  bar.className = "status";
  bar.textContent = "–í—ã–±–µ—Ä–∏ –µ–¥–∏–Ω–∏—Ü—É: ";
  units.forEach(u=>{
    const b=document.createElement("button");
    b.className="btn secondary miniBtn";
    b.textContent=u.unit;
    b.onclick=()=>{ selectedUnit=u.unit; log("–µ–¥.–∏–∑–º.: "+selectedUnit); };
    bar.appendChild(b);
  });
  S("unitBar").innerHTML="";
  S("unitBar").appendChild(bar);
}

async function sendCook(){
  try {
    const qty = S("qty").value;
    const reason = S("reason").value || "";

    if(operation==="—Å–ø–∏—Å–∞–Ω–∏–µ"){
      const free = (document.getElementById("freeName")?.value || "").trim();
      if(!free) return alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏");
      selectedName = free;
      if(!selectedUnit) return alert("–í—ã–±–µ—Ä–∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è");
      if(!qty) return alert("–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
    } else {
      if(!selectedName) return alert("–í—ã–±–µ—Ä–∏ –ø–æ–∑–∏—Ü–∏—é");
      if(!qty) return alert("–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
      if(!selectedUnit) return alert("–ù–µ—Ç –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è");
    }

    const res = await apiPost({
      role:"–ø–æ–≤–∞—Ä",
      operation,
      name:selectedName,
      quantity:qty,
      unit:selectedUnit,
      reason
    });

    if(res && res.ok===false){
      log("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: "+JSON.stringify(res));
      return alert("–ù–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å. –°–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É.");
    }

    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
    S("qty").value=""; S("reason").value="";
    backToMenu();
  } catch(e){
    log("sendCook error: "+String(e));
    alert("–û—à–∏–±–∫–∞. –°–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É.");
  }
}

// ---------- CASHIER ----------
function openCash(op){
  operation = op;
  showWork(op==="–≤–Ω–µ—Å–µ–Ω–∏–µ" ? "–í–Ω–µ—Å–µ–Ω–∏–µ" : "–ò–∑—ä—è—Ç–∏–µ");
  S("cashBlock").classList.remove("hidden");
  S("rub").value=""; S("kop").value=""; S("cashReason").value="";
  log("–∫–∞—Å—Å–∏—Ä: "+operation);
}

async function openCashWriteoff(){
  operation="—Å–ø–∏—Å–∞–Ω–∏–µ";
  showWork("–°–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–∞: –≤–≤–µ–¥–∏ –ø–æ–∑–∏—Ü–∏—é");
  S("dynamic").innerHTML = `<input id="freeNameCash" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏">`;
  S("qtyBlock").classList.remove("hidden");
  S("reason").placeholder = "–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è";
  await renderUnitsBar();
  log("–∫–∞—Å—Å–∏—Ä —Å–ø–∏—Å–∞–Ω–∏–µ: –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
}

async function sendCash(){
  try {
    const rub = S("rub").value || "0";
    const kop = S("kop").value || "0";
    const reason = (S("cashReason").value || "").trim();
    if(!reason) return alert("–£–∫–∞–∂–∏ –ø—Ä–∏—á–∏–Ω—É");

    const res = await apiPost({
      role:"–∫–∞—Å—Å–∏—Ä",
      operation,
      amount_rub: rub,
      amount_kop: kop,
      reason
    });

    if(res && res.ok===false){
      log("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: "+JSON.stringify(res));
      return alert("–ù–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å. –°–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É.");
    }

    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
    backToMenu();
  } catch(e){
    log("sendCash error: "+String(e));
    alert("–û—à–∏–±–∫–∞. –°–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É.");
  }
}
</script>
</body>
</html>
