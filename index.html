<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team App</title>
  <script src="https://telegram.org/js/telegram-web-app.js?v=2002"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Arial;background:#f5f5f5;margin:0;padding:16px}
    .card{background:#fff;border-radius:12px;padding:12px;margin:12px 0}
    h2,h3{margin:8px 0;text-align:center}
    .btn{width:100%;padding:12px;margin:8px 0;border:0;border-radius:10px;font-size:16px}
    .primary{background:#2AABEE;color:#fff}
    .secondary{background:#e6e6e6}
    .warn{background:#fb8500;color:#fff}
    .hidden{display:none}
    .status{white-space:pre-wrap;font-size:13px;opacity:.9}
    input,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .row input{flex:1}
    .mini{display:inline-block;width:auto;margin:6px 6px 0 0;padding:8px 10px}
    .picked{outline:2px solid #2AABEE}
  </style>
</head>
<body>

<h2>–û—Ç—á—ë—Ç—ã</h2>
<div id="status" class="card status">–°—Ç–∞—Ç—É—Å: –≥–æ—Ç–æ–≤–æ</div>

<div id="roleScreen" class="card">
  <h3>–ö—Ç–æ —Ç—ã —Å–µ–≥–æ–¥–Ω—è?</h3>
  <button id="btnCook" class="btn primary">üë®‚Äçüç≥ –ü–æ–≤–∞—Ä</button>
  <button id="btnCashier" class="btn primary">üí≥ –ö–∞—Å—Å–∏—Ä</button>
</div>

<div id="cookMenu" class="card hidden">
  <h3>–ú–µ–Ω—é –ø–æ–≤–∞—Ä–∞</h3>
  <button id="btnPrep" class="btn secondary">üçù –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</button>
  <button id="btnWriteoffCook" class="btn secondary">üóë –°–ø–∏—Å–∞–Ω–∏–µ</button>
  <button id="btnBreakdown" class="btn secondary">üì¶ –†–∞–∑–±–æ—Ä</button>
  <button id="btnReset1" class="btn warn">üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
</div>

<div id="cashierMenu" class="card hidden">
  <h3>–ú–µ–Ω—é –∫–∞—Å—Å–∏—Ä–∞</h3>
  <button id="btnCashIn" class="btn secondary">‚ûï –í–Ω–µ—Å–µ–Ω–∏–µ</button>
  <button id="btnCashOut" class="btn secondary">‚ûñ –ò–∑—ä—è—Ç–∏–µ</button>
  <button id="btnWriteoffCash" class="btn secondary">üóë –°–ø–∏—Å–∞–Ω–∏–µ</button>
  <button id="btnReset2" class="btn warn">üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
</div>

<div id="workScreen" class="card hidden">
  <h3 id="workTitle">...</h3>
  <div id="dynamic"></div>

  <div id="qtyBlock" class="hidden">
    <input id="qty" type="number" inputmode="decimal" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <div id="unitBar" class="status"></div>
    <textarea id="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>

    <button id="btnSendCook" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="btnBack" class="btn secondary">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="cashBlock" class="hidden">
    <div class="row">
      <input id="rub" type="number" inputmode="numeric" placeholder="–†—É–±–ª–∏">
      <input id="kop" type="number" inputmode="numeric" placeholder="–ö–æ–ø–µ–π–∫–∏">
    </div>
    <textarea id="cashReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞"></textarea>

    <button id="btnSendCash" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="btnBack2" class="btn secondary">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<script>
Telegram.WebApp.ready();

const API_URL = https://script.google.com/macros/s/AKfycbyA9K_vklUqol1na4NjZqAzz7pp4ClxZgI21ocMingm6cmV2Mni_-dW_gfItOV2_7oI/exec
const S = (id)=>document.getElementById(id);
const log = (m)=>S("status").textContent="–°—Ç–∞—Ç—É—Å: "+m;

let role = localStorage.getItem("role") || "";
let operation = "";
let selectedName = "";
let selectedUnit = "";
let breakdownFrom = "";

function show(id){ S(id).classList.remove("hidden"); }
function hide(id){ S(id).classList.add("hidden"); }

function boot(){
  if(role==="–ø–æ–≤–∞—Ä"){ hide("roleScreen"); show("cookMenu"); log("—Ä–æ–ª—å: –ø–æ–≤–∞—Ä"); }
  else if(role==="–∫–∞—Å—Å–∏—Ä"){ hide("roleScreen"); show("cashierMenu"); log("—Ä–æ–ª—å: –∫–∞—Å—Å–∏—Ä"); }
  else log("–≤—ã–±–µ—Ä–∏ —Ä–æ–ª—å");
}

function setRole(r){
  role=r;
  localStorage.setItem("role", r);
  hide("roleScreen");
  if(r==="–ø–æ–≤–∞—Ä") show("cookMenu");
  if(r==="–∫–∞—Å—Å–∏—Ä") show("cashierMenu");
  log("—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: "+r);
}

function resetRole(){
  localStorage.removeItem("role");
  role="";
  hide("cookMenu"); hide("cashierMenu"); hide("workScreen");
  show("roleScreen");
  log("—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω–∞");
}

function showWork(title){
  hide("cookMenu"); hide("cashierMenu");
  show("workScreen");
  S("workTitle").textContent = title;
  S("dynamic").innerHTML = "";
  hide("qtyBlock"); hide("cashBlock");
  selectedName=""; selectedUnit=""; breakdownFrom="";
}

function backToMenu(){
  hide("workScreen");
  if(role==="–ø–æ–≤–∞—Ä") show("cookMenu");
  if(role==="–∫–∞—Å—Å–∏—Ä") show("cashierMenu");
  log("–≥–æ—Ç–æ–≤–æ");
}

// ---- API
async function apiGet(type, params={}){
  const url = new URL(API_URL);
  url.searchParams.set("type", type);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r = await fetch(url.toString(), { method:"GET" });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"Non-JSON", raw:t.slice(0,300) }; }
}

async function apiPost(payload){
  const r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:true, raw:t }; }
}

// ---- UI render
function renderButtons(list, onPick){
  if(!Array.isArray(list)){
    S("dynamic").innerHTML = `<div class="status">–û—à–∏–±–∫–∞: ${JSON.stringify(list)}</div>`;
    log("–æ—à–∏–±–∫–∞ API");
    return;
  }
  if(list.length===0){
    S("dynamic").innerHTML = `<div class="status">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç (–ø—Ä–æ–≤–µ—Ä—å active)</div>`;
    log("—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç");
    return;
  }
  list.forEach(item=>{
    const b=document.createElement("button");
    b.className="btn secondary";
    b.textContent = `${item.name} (${item.unit})`;
    b.onclick=()=>onPick(item);
    S("dynamic").appendChild(b);
  });
}

async function renderUnitsPick(){
  const units = await apiGet("units");
  const bar = S("unitBar");
  bar.innerHTML = "";
  if(!Array.isArray(units) || units.length===0){
    bar.textContent = "–ï–¥–∏–Ω–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
    return;
  }
  bar.textContent = "–í—ã–±–µ—Ä–∏ –µ–¥–∏–Ω–∏—Ü—É: ";
  units.forEach(u=>{
    const b=document.createElement("button");
    b.className="btn secondary mini";
    b.textContent = u.unit;
    b.onclick=()=>{
      selectedUnit=u.unit;
      log("–µ–¥.–∏–∑–º.: "+selectedUnit);
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
      Array.from(bar.querySelectorAll("button")).forEach(x=>x.classList.remove("picked"));
      b.classList.add("picked");
    };
    bar.appendChild(b);
  });
}

// ---- COOK FLOWS
async function openCookPrep(){
  operation="–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ";
  showWork("–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: –≤—ã–±–µ—Ä–∏ –ø–æ–∑–∏—Ü–∏—é");
  log("–∑–∞–≥—Ä—É–∑–∫–∞ prep‚Ä¶");
  const list = await apiGet("prep");
  renderButtons(list, (item)=>{
    selectedName=item.name;
    selectedUnit=item.unit;
    show("qtyBlock");
    S("unitBar").textContent = "–ï–¥. –∏–∑–º.: " + selectedUnit;
    S("reason").placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)";
    log("–≤—ã–±—Ä–∞–Ω–æ: "+selectedName);
  });
}

async function openCookWriteoff(){
  operation="—Å–ø–∏—Å–∞–Ω–∏–µ";
  showWork("–°–ø–∏—Å–∞–Ω–∏–µ: –≤–≤–µ–¥–∏ –ø–æ–∑–∏—Ü–∏—é");
  S("dynamic").innerHTML = `<input id="freeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏">`;
  show("qtyBlock");
  S("reason").placeholder="–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è";
  await renderUnitsPick();
  log("—Å–ø–∏—Å–∞–Ω–∏–µ: –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
}

async function openCookBreakdown(){
  operation="—Ä–∞–∑–±–æ—Ä";
  showWork("–†–∞–∑–±–æ—Ä: –≤—ã–±–µ—Ä–∏ —á—Ç–æ —Ä–∞–∑–±–∏—Ä–∞–µ–º");
  log("–∑–∞–≥—Ä—É–∑–∫–∞ breakdown‚Ä¶");
  const list = await apiGet("breakdown");
  renderButtons(list, async (item)=>{
    breakdownFrom = item.name;
    log("–≤—ã–±—Ä–∞–Ω–æ: "+breakdownFrom+" ‚Üí –∑–∞–≥—Ä—É–∂–∞—é –≤–∞—Ä–∏–∞–Ω—Ç—ã");
    await openBreakdownTo(breakdownFrom);
  });
}

async function openBreakdownTo(from){
  S("workTitle").textContent = `–†–∞–∑–±–æ—Ä: ${from} ‚Üí –≤—ã–±–µ—Ä–∏ –Ω–∞ —á—Ç–æ`;
  S("dynamic").innerHTML = "";
  hide("qtyBlock");
  const list = await apiGet("breakdown_map", { from });
  renderButtons(list, (item)=>{
    selectedName = `${from} ‚Üí ${item.name}`;
    selectedUnit = item.unit;
    show("qtyBlock");
    S("unitBar").textContent = "–ï–¥. –∏–∑–º.: " + selectedUnit;
    S("reason").placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)";
    log("–≤—ã–±—Ä–∞–Ω–æ: "+selectedName);
  });
}

async function sendCook(){
  const qty = S("qty").value;
  const reason = S("reason").value || "";

  if(operation==="—Å–ø–∏—Å–∞–Ω–∏–µ"){
    const free = (document.getElementById("freeName")?.value || "").trim();
    if(!free) return alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏");
    if(!selectedUnit) return alert("–í—ã–±–µ—Ä–∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è");
    if(!qty) return alert("–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
    selectedName = free;
  } else {
    if(!selectedName) return alert("–í—ã–±–µ—Ä–∏ –ø–æ–∑–∏—Ü–∏—é");
    if(!qty) return alert("–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
  }

  log("–æ—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶");
  const res = await apiPost({
    role:"–ø–æ–≤–∞—Ä",
    operation,
    name:selectedName,
    quantity:qty,
    unit:selectedUnit,
    reason
  });

  if(res && res.ok===false){
    log("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: "+JSON.stringify(res));
    return alert("–ù–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å. –°–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É.");
  }

  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
  S("qty").value=""; S("reason").value="";
  backToMenu();
}

// ---- CASHIER FLOWS
function openCash(op){
  operation=op;
  showWork(op==="–≤–Ω–µ—Å–µ–Ω–∏–µ" ? "–í–Ω–µ—Å–µ–Ω–∏–µ" : "–ò–∑—ä—è—Ç–∏–µ");
  show("cashBlock");
  S("rub").value=""; S("kop").value=""; S("cashReason").value="";
  log("–∫–∞—Å—Å–∏—Ä: "+operation);
}

async function openCashWriteoff(){
  operation="—Å–ø–∏—Å–∞–Ω–∏–µ";
  showWork("–°–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–∞: –≤–≤–µ–¥–∏ –ø–æ–∑–∏—Ü–∏—é");
  S("dynamic").innerHTML = `<input id="freeNameCash" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏">`;
  show("qtyBlock");
  S("reason").placeholder="–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è";
  await renderUnitsPick();
  log("–∫–∞—Å—Å–∏—Ä —Å–ø–∏—Å–∞–Ω–∏–µ: –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
}

async function sendCash(){
  const rub = S("rub").value || "0";
  const kop = S("kop").value || "0";
  const reason = (S("cashReason").value || "").trim();
  if(!reason) return alert("–£–∫–∞–∂–∏ –ø—Ä–∏—á–∏–Ω—É");

  log("–æ—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶");
  const res = await apiPost({
    role:"–∫–∞—Å—Å–∏—Ä",
    operation,
    amount_rub: rub,
    amount_kop: kop,
    reason
  });

  if(res && res.ok===false){
    log("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: "+JSON.stringify(res));
    return alert("–ù–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å. –°–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É.");
  }

  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
  backToMenu();
}

// ---- Bind events
document.addEventListener("DOMContentLoaded", ()=>{
  S("btnCook").addEventListener("click", ()=>setRole("–ø–æ–≤–∞—Ä"));
  S("btnCashier").addEventListener("click", ()=>setRole("–∫–∞—Å—Å–∏—Ä"));
  S("btnReset1").addEventListener("click", resetRole);
  S("btnReset2").addEventListener("click", resetRole);

  S("btnPrep").addEventListener("click", openCookPrep);
  S("btnWriteoffCook").addEventListener("click", openCookWriteoff);
  S("btnBreakdown").addEventListener("click", openCookBreakdown);

  S("btnCashIn").addEventListener("click", ()=>openCash("–≤–Ω–µ—Å–µ–Ω–∏–µ"));
  S("btnCashOut").addEventListener("click", ()=>openCash("–∏–∑—ä—è—Ç–∏–µ"));
  S("btnWriteoffCash").addEventListener("click", openCashWriteoff);

  S("btnSendCook").addEventListener("click", sendCook);
  S("btnSendCash").addEventListener("click", sendCash);

  S("btnBack").addEventListener("click", backToMenu);
  S("btnBack2").addEventListener("click", backToMenu);

  boot();
});
</script>

</body>
</html>
