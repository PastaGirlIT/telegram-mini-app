<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{font-family:Arial;padding:20px;background:#f5f5f5}
button{padding:12px;margin:5px 0;width:100%;border:none;border-radius:8px}
.primary{background:#2AABEE;color:white}
.secondary{background:#ddd}
.hidden{display:none}
input{width:100%;padding:10px;margin:5px 0}
</style>
</head>
<body>

<h2>Mini App</h2>

<div id="roleScreen">
<button class="primary" onclick="setRole('повар')">Повар</button>
<button class="primary" onclick="setRole('кассир')">Кассир</button>
</div>

<div id="cookMenu" class="hidden">
<button onclick="cookPrep()">Приготовление</button>
<button onclick="cookWriteoff()">Списание</button>
<button onclick="cookBreakdown()">Разбор</button>
</div>

<div id="cashierMenu" class="hidden">
<button onclick="cashIn()">Внесение</button>
<button onclick="cashOut()">Изъятие</button>
<button onclick="cashWriteoff()">Списание</button>
</div>

<div id="workScreen" class="hidden">
<h3 id="title"></h3>
<div id="dynamic"></div>
<input id="quantity" placeholder="Количество">
<div id="units"></div>
<input id="reason" placeholder="Причина (если нужно)">
<button class="primary" onclick="send()">Отправить</button>
<button onclick="back()">Назад</button>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbzJg3OfKzXXojWydq3d6_mTAn5r6_pv-R_U2_peOwme_wVUc7ZX5hqUKvpH4FhgJQTj/exec";

let role, operation, selectedName="", selectedUnit="";

function setRole(r){
role=r;
document.getElementById("roleScreen").classList.add("hidden");
if(r==="повар") document.getElementById("cookMenu").classList.remove("hidden");
if(r==="кассир") document.getElementById("cashierMenu").classList.remove("hidden");
}

function showWork(title){
document.getElementById("title").innerText=title;
document.getElementById("cookMenu").classList.add("hidden");
document.getElementById("cashierMenu").classList.add("hidden");
document.getElementById("workScreen").classList.remove("hidden");
}

async function cookPrep(){
operation="приготовление";
showWork("Приготовление");
loadButtons("prep");
}

async function cookWriteoff(){
operation="списание";
showWork("Списание");
loadUnits();
}

async function cookBreakdown(){
operation="разбор";
showWork("Разбор");
loadButtons("breakdown");
}

async function cashIn(){
operation="внесение";
showWork("Внесение");
}

async function cashOut(){
operation="изъятие";
showWork("Изъятие");
}

async function cashWriteoff(){
operation="списание";
showWork("Списание");
loadUnits();
}

async function loadButtons(type){
const res=await fetch(URL+"?type="+type);
const data=await res.json();
const div=document.getElementById("dynamic");
div.innerHTML="";
data.forEach(i=>{
let b=document.createElement("button");
b.className="secondary";
b.innerText=i.name+" ("+i.unit+")";
b.onclick=()=>{
selectedName=i.name;
selectedUnit=i.unit;
if(operation==="разбор") loadBreakdownMap(i.name);
};
div.appendChild(b);
});
}

async function loadBreakdownMap(name){
const res=await fetch(URL+"?type=breakdown_map&from="+name);
const data=await res.json();
const div=document.getElementById("dynamic");
div.innerHTML="";
data.forEach(i=>{
let b=document.createElement("button");
b.innerText=i.name+" ("+i.unit+")";
b.onclick=()=>{
selectedName=name+" → "+i.name;
selectedUnit=i.unit;
};
div.appendChild(b);
});
}

async function loadUnits(){
const res=await fetch(URL+"?type=units");
const data=await res.json();
const div=document.getElementById("units");
div.innerHTML="";
data.forEach(u=>{
let b=document.createElement("button");
b.innerText=u.unit;
b.onclick=()=>selectedUnit=u.unit;
div.appendChild(b);
});
}

async function send(){
let qty=document.getElementById("quantity").value;
let reason=document.getElementById("reason").value;

if(role==="кассир"){
let amount=qty;
await fetch(URL,{method:"POST",body:JSON.stringify({role,operation,amount,reason})});
alert("Сохранено");
return;
}

await fetch(URL,{
method:"POST",
body:JSON.stringify({
role,
operation,
name:selectedName,
quantity:qty,
unit:selectedUnit,
reason
})
});

alert("Сохранено");
}

function back(){
location.reload();
}
</script>

</body>
</html>
